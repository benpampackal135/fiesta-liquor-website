<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Import - Fiesta Liquor Admin</title>
    <link rel="stylesheet" href="public/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            background: #f8f9fa;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a1a2e;
            text-align: center;
            margin-bottom: 30px;
            font-family: 'Playfair Display', serif;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #ffd700;
            background: #fffbf0;
        }
        .upload-area.dragover {
            border-color: #4CAF50;
            background: #f0f8f0;
        }
        input[type="file"] {
            margin: 20px 0;
        }
        button {
            background: #1a1a2e;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            font-weight: 600;
        }
        button:hover {
            background: #ffd700;
            color: #1a1a2e;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .preview {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #1a1a2e;
        }
        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            margin-top: 0;
            color: #1976d2;
        }
        .instructions ol {
            margin: 10px 0;
        }
        .instructions li {
            margin: 5px 0;
        }
        .download-template {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            display: inline-block;
            margin: 10px 0;
            font-weight: 600;
        }
        .download-template:hover {
            background: #45a049;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #1a1a2e;
            text-decoration: none;
            font-weight: 600;
        }
        .back-link:hover {
            color: #ffd700;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/admin-dashboard.html" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        
        <h1>üç∑ Product Import Tool</h1>
        
        <div class="instructions">
            <h3>üìã How to Import Your Products:</h3>
            <p><strong>Option 1: Google Sheets Import (Recommended)</strong></p>
            <ol>
                <li>Open your Google Sheet with products (columns: barcode, name, size, price)</li>
                <li>Click <strong>File ‚Üí Share ‚Üí Publish to web</strong></li>
                <li>Select the sheet and choose <strong>CSV</strong> format</li>
                <li>Copy the published link and paste it below</li>
                <li>Click "Load from Google Sheets" to import</li>
            </ol>
            <p><strong>Option 2: CSV File Upload</strong></p>
            <ol>
                <li>Export your Google Sheet as CSV (File ‚Üí Download ‚Üí CSV)</li>
                <li>Upload the CSV file below</li>
            </ol>
            <p><strong>Expected Format:</strong> Your spreadsheet should have columns: <code>barcode</code>, <code>name</code>, <code>size</code>, <code>price</code> (and optionally <code>category</code>, <code>description</code>)</p>
        </div>

        <div id="messageArea"></div>

        <!-- Google Sheets Import -->
        <div style="background: #f0f8ff; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #4CAF50;">
            <h3 style="margin-top: 0; color: #1976d2;">
                <i class="fab fa-google"></i> Import from Google Sheets
            </h3>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <input 
                    type="text" 
                    id="googleSheetsUrl" 
                    placeholder="Paste your Google Sheets published CSV URL here..."
                    style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;"
                >
                <button onclick="loadFromGoogleSheets()" style="background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-cloud-download-alt"></i> Load from Google Sheets
                </button>
            </div>
            <p style="margin-top: 10px; font-size: 12px; color: #666;">
                <strong>Tip:</strong> Make sure your Google Sheet is published as CSV. The URL should look like: 
                <code>https://docs.google.com/spreadsheets/d/.../export?format=csv&gid=...</code>
            </p>
        </div>

        <!-- CSV File Upload -->
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('csvFile').click()">
            <h3>üìÅ Or Upload Your Product CSV File</h3>
            <p>Drag and drop your CSV file here, or click to select</p>
            <input type="file" id="csvFile" accept=".csv" onchange="handleFileSelect(event)" style="display: none;">
            <p><small>Supported format: CSV files only</small></p>
        </div>

        <div id="preview" class="preview" style="display: none;">
            <h3>üëÄ Preview Products</h3>
            <div id="categorySelector" style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; display: none;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                    <i class="fas fa-tag"></i> Set Default Category for Products Without Category:
                </label>
                <select id="defaultCategory" style="padding: 8px; border: 2px solid #ddd; border-radius: 5px; width: 200px;">
                    <option value="whiskey">Whiskey</option>
                    <option value="tequila">Tequila</option>
                    <option value="vodka">Vodka</option>
                    <option value="gin">Gin</option>
                    <option value="rum">Rum</option>
                    <option value="beer-seltzers">Beer & Seltzers</option>
                    <option value="wine">Wine</option>
                </select>
            </div>
            <div id="previewTable"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-success" onclick="importProducts()">
                    <i class="fas fa-check"></i> Import to Website
                </button>
                <button class="btn-danger" onclick="clearPreview()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <script src="public/api.js"></script>
    <script>
        let csvData = [];
        let isImporting = false;
        
        // Check if user is admin
        async function checkAuth() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/auth.html';
                return false;
            }
            
            try {
                const user = await authAPI.getCurrentUser();
                if (user.role !== 'admin') {
                    window.location.href = '/auth.html';
                    return false;
                }
                return true;
            } catch (error) {
                window.location.href = '/auth.html';
                return false;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuth();
        });
        
        function showMessage(message, type = 'success') {
            const messageArea = document.getElementById('messageArea');
            const className = type === 'success' ? 'success-message' : 'error-message';
            messageArea.innerHTML = `<div class="${className}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }
        
        // Load from Google Sheets
        async function loadFromGoogleSheets() {
            const url = document.getElementById('googleSheetsUrl').value.trim();
            
            if (!url) {
                showMessage('Please enter a Google Sheets URL.', 'error');
                return;
            }
            
            // Ensure URL is a CSV export
            let csvUrl = url;
            if (url.includes('docs.google.com/spreadsheets')) {
                // Extract sheet ID
                const sheetIdMatch = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                if (sheetIdMatch) {
                    const sheetId = sheetIdMatch[1];
                    // Extract gid if present
                    const gidMatch = url.match(/[#&]gid=(\d+)/);
                    const gid = gidMatch ? gidMatch[1] : '0';
                    
                    // Build CSV export URL
                    csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                } else if (!url.includes('/export')) {
                    showMessage('Invalid Google Sheets URL. Please use a shareable link or published CSV URL.', 'error');
                    return;
                } else if (!url.includes('format=csv')) {
                    // Already an export URL, just ensure format is CSV
                    csvUrl = url.replace(/format=[^&]+/, 'format=csv');
                    if (!csvUrl.includes('format=csv')) {
                        csvUrl += (url.includes('?') ? '&' : '?') + 'format=csv';
                    }
                }
            } else if (!url.includes('http')) {
                showMessage('Please enter a valid URL starting with http:// or https://', 'error');
                return;
            }
            
            showMessage('Loading data from Google Sheets...', 'success');
            
            try {
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to fetch data. Make sure the sheet is published to web.`);
                }
                
                const csvText = await response.text();
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('The sheet appears to be empty or not accessible.');
                }
                
                parseCSVText(csvText);
            } catch (error) {
                console.error('Google Sheets import error:', error);
                let errorMsg = 'Error loading from Google Sheets: ' + error.message;
                errorMsg += '<br><br><strong>How to fix:</strong>';
                errorMsg += '<br>1. Open your Google Sheet';
                errorMsg += '<br>2. Click <strong>File ‚Üí Share ‚Üí Publish to web</strong>';
                errorMsg += '<br>3. Select the sheet tab and choose <strong>CSV</strong> format';
                errorMsg += '<br>4. Copy the published link and paste it here';
                showMessage(errorMsg, 'error');
            }
        }
        
        // Parse CSV text (used by both file upload and Google Sheets)
        function parseCSVText(csvText) {
            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    showMessage('CSV file is empty or has no data rows.', 'error');
                    return;
                }
                
                // Parse header row
                const headers = parseCSVLine(lines[0]).map(h => h.trim().toLowerCase());
                
                // Check if this is the barcode/name/size/price format
                const hasBarcode = headers.includes('barcode');
                const hasName = headers.includes('name') || headers.includes('product name') || headers.includes('product');
                const hasSize = headers.includes('size');
                const hasPrice = headers.includes('price');
                
                if (hasBarcode && hasName && hasSize && hasPrice) {
                    // New format: barcode, name, size, price
                    parseBarcodeFormat(lines, headers);
                } else {
                    // Old format: name, category, description, etc.
                    parseStandardFormat(lines, headers);
                }
            } catch (error) {
                console.error('CSV parsing error:', error);
                showMessage('Error parsing CSV file. Please check the format.', 'error');
            }
        }
        
        // Parse CSV line handling quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current); // Add last field
            return result;
        }
        
        // Parse barcode/name/size/price format
        function parseBarcodeFormat(lines, headers) {
            const barcodeIndex = headers.indexOf('barcode');
            const nameIndex = headers.findIndex(h => h.includes('name') || h.includes('product'));
            const sizeIndex = headers.indexOf('size');
            const priceIndex = headers.indexOf('price');
            const categoryIndex = headers.findIndex(h => h.includes('category'));
            const descIndex = headers.findIndex(h => h.includes('description') || h.includes('desc'));
            
            // Group products by name (or barcode if name is missing)
            const productMap = new Map();
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = parseCSVLine(lines[i]);
                const barcode = barcodeIndex >= 0 ? (values[barcodeIndex] || '').trim() : '';
                const name = nameIndex >= 0 ? (values[nameIndex] || '').trim() : '';
                const size = sizeIndex >= 0 ? (values[sizeIndex] || '').trim() : '';
                const priceStr = priceIndex >= 0 ? (values[priceIndex] || '').trim() : '';
                const category = categoryIndex >= 0 ? (values[categoryIndex] || '').trim() : '';
                const description = descIndex >= 0 ? (values[descIndex] || '').trim() : '';
                
                if (!name && !barcode) continue; // Skip rows without name or barcode
                
                const productKey = name || barcode;
                const price = parseFloat(priceStr.replace(/[^0-9.]/g, '')) || 0;
                
                if (!productMap.has(productKey)) {
                    productMap.set(productKey, {
                        name: name || `Product ${barcode}`,
                        barcode: barcode,
                        category: category || detectCategory(name),
                        description: description || `${name || 'Premium product'}`,
                        image: 'images/product_placeholder.svg',
                        inStock: true,
                        sizes: []
                    });
                }
                
                // Add size if provided
                if (size && price > 0) {
                    const product = productMap.get(productKey);
                    product.sizes.push({
                        size: size,
                        price: price,
                        inStock: true
                    });
                } else if (price > 0) {
                    // If no size but has price, use as default price
                    const product = productMap.get(productKey);
                    if (product.sizes.length === 0) {
                        product.price = price;
                    }
                }
            }
            
            // Convert map to array
            csvData = Array.from(productMap.values());
            
            // Set default price from first size if no base price
            csvData.forEach(product => {
                if (!product.price && product.sizes.length > 0) {
                    product.price = product.sizes[0].price;
                }
            });
            
            if (csvData.length > 0) {
                showPreview();
                showMessage(`Successfully parsed ${csvData.length} product(s) from ${lines.length - 1} row(s)!`, 'success');
            } else {
                showMessage('No valid products found in CSV file.', 'error');
            }
        }
        
        // Parse standard format (old format)
        function parseStandardFormat(lines, headers) {
            csvData = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = parseCSVLine(lines[i]);
                const product = {};
                
                headers.forEach((header, index) => {
                    const value = (values[index] || '').trim().replace(/^"|"$/g, '');
                    if (header === 'name') product.name = value;
                    else if (header === 'category') product.category = value;
                    else if (header === 'description') product.description = value;
                    else if (header === 'image') product.image = value || 'images/product_placeholder.svg';
                    else if (header === 'price') product.price = parseFloat(value) || 0;
                    else if (header === 'instock') product.inStock = value.toLowerCase() === 'true' || value === '1';
                });
                
                // Parse sizes if provided
                const sizesIndex = headers.indexOf('sizes');
                if (sizesIndex !== -1 && values[sizesIndex]) {
                    const sizesString = values[sizesIndex].replace(/"/g, '');
                    const sizePairs = sizesString.split(',');
                    product.sizes = [];
                    sizePairs.forEach(pair => {
                        const [size, price] = pair.split(':');
                        if (size && price) {
                            product.sizes.push({
                                size: size.trim(),
                                price: parseFloat(price.trim()) || 0,
                                inStock: true
                            });
                        }
                    });
                }
                
                if (product.name && product.category) {
                    csvData.push(product);
                }
            }
            
            if (csvData.length > 0) {
                showPreview();
            } else {
                showMessage('No valid products found in CSV file.', 'error');
            }
        }
        
        // Detect category from product name
        function detectCategory(name) {
            const nameLower = name.toLowerCase();
            if (nameLower.includes('whiskey') || nameLower.includes('whisky') || nameLower.includes('bourbon') || nameLower.includes('scotch')) {
                return 'whiskey';
            } else if (nameLower.includes('tequila')) {
                return 'tequila';
            } else if (nameLower.includes('vodka')) {
                return 'vodka';
            } else if (nameLower.includes('gin')) {
                return 'gin';
            } else if (nameLower.includes('rum')) {
                return 'rum';
            } else if (nameLower.includes('beer') || nameLower.includes('seltzer') || nameLower.includes('claw') || nameLower.includes('truly')) {
                return 'beer-seltzers';
            } else if (nameLower.includes('wine') || nameLower.includes('champagne')) {
                return 'wine';
            }
            return 'whiskey'; // Default
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && (file.type === 'text/csv' || file.name.endsWith('.csv'))) {
                parseCSV(file);
            } else {
                showMessage('Please select a valid CSV file.', 'error');
            }
        }

        // Parse CSV file
        function parseCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSVText(e.target.result);
            };
            reader.readAsText(file);
        }

        // Show preview
        function showPreview() {
            const preview = document.getElementById('preview');
            const previewTable = document.getElementById('previewTable');
            const categorySelector = document.getElementById('categorySelector');
            
            const hasBarcode = csvData.some(p => p.barcode);
            const hasMissingCategories = csvData.some(p => !p.category);
            
            // Show category selector if there are products without categories
            if (hasMissingCategories) {
                categorySelector.style.display = 'block';
            } else {
                categorySelector.style.display = 'none';
            }
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            ${hasBarcode ? '<th>Barcode</th>' : ''}
                            <th>Name</th>
                            <th>Category</th>
                            <th>Sizes & Prices</th>
                            <th>In Stock</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            csvData.forEach(product => {
                let priceDisplay = '';
                if (product.sizes && product.sizes.length > 0) {
                    priceDisplay = product.sizes.map(s => `${s.size}: $${s.price.toFixed(2)}`).join('<br>');
                } else if (product.price) {
                    priceDisplay = `$${product.price.toFixed(2)}`;
                } else {
                    priceDisplay = 'No price set';
                }
                
                const categoryDisplay = product.category || '<span style="color: #f44336;">‚ö†Ô∏è Not set</span>';
                
                tableHTML += `
                    <tr>
                        ${hasBarcode ? `<td>${product.barcode || '-'}</td>` : ''}
                        <td><strong>${product.name}</strong></td>
                        <td>${categoryDisplay}</td>
                        <td>${priceDisplay}</td>
                        <td>${product.inStock !== false ? '‚úÖ Yes' : '‚ùå No'}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            previewTable.innerHTML = tableHTML;
            preview.style.display = 'block';
            
            // Show summary
            const totalProducts = csvData.length;
            const totalSizes = csvData.reduce((sum, p) => sum + (p.sizes?.length || 0), 0);
            const summary = document.createElement('div');
            summary.style.cssText = 'margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 8px; font-weight: 600;';
            summary.innerHTML = `üìä Summary: ${totalProducts} product(s) with ${totalSizes || totalProducts} size/price combination(s) ready to import`;
            previewTable.parentElement.insertBefore(summary, previewTable.nextSibling);
        }

        // Import products to API
        async function importProducts() {
            if (isImporting) return;
            
            if (csvData.length === 0) {
                showMessage('No products to import.', 'error');
                return;
            }
            
            // Get default category if set
            const defaultCategory = document.getElementById('defaultCategory')?.value || 'whiskey';
            
            isImporting = true;
            const preview = document.getElementById('preview');
            preview.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Importing products...</div>';
            
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            try {
                for (const product of csvData) {
                    try {
                        // Ensure product has required fields
                        const productToImport = {
                            ...product,
                            category: product.category || defaultCategory,
                            description: product.description || product.name,
                            image: product.image || 'images/product_placeholder.svg',
                            inStock: product.inStock !== undefined ? product.inStock : true
                        };
                        
                        // Ensure sizes have inStock property
                        if (productToImport.sizes && productToImport.sizes.length > 0) {
                            productToImport.sizes = productToImport.sizes.map(s => ({
                                ...s,
                                inStock: s.inStock !== undefined ? s.inStock : true
                            }));
                        }
                        
                        await productsAPI.create(productToImport);
                        successCount++;
                    } catch (error) {
                        console.error('Error importing product:', product.name, error);
                        errorCount++;
                        errors.push(`${product.name}: ${error.message || 'Unknown error'}`);
                    }
                }
                
                if (successCount > 0) {
                    let message = `‚úÖ Successfully imported ${successCount} product(s)!`;
                    if (errorCount > 0) {
                        message += ` ${errorCount} failed.`;
                        console.error('Import errors:', errors);
                    }
                    showMessage(message, 'success');
                    setTimeout(() => {
                        window.location.href = '/admin-dashboard.html';
                    }, 2000);
                } else {
                    showMessage(`‚ùå Failed to import products. Errors: ${errors.join('; ')}`, 'error');
                    preview.style.display = 'none';
                }
            } catch (error) {
                console.error('Import error:', error);
                showMessage('Error importing products. Please try again.', 'error');
                preview.style.display = 'none';
            } finally {
                isImporting = false;
            }
        }

        // Clear preview
        function clearPreview() {
            document.getElementById('preview').style.display = 'none';
            document.getElementById('csvFile').value = '';
            csvData = [];
        }

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    parseCSV(file);
                } else {
                    showMessage('Please select a valid CSV file.', 'error');
                }
            }
        });
    </script>
</body>
</html>
